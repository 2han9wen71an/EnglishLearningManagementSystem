<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>进行考试 - 英语知识应用网站系统</title>
    <meta name="description" content="进行考试">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="https://i.imgur.com/QRAUqs9.png">
    <link rel="shortcut icon" href="https://i.imgur.com/QRAUqs9.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lykmapipo/themify-icons@0.1.2/css/themify-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pixeden-stroke-7-icon@1.2.3/pe-icon-7-stroke/dist/pe-icon-7-stroke.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.0/css/flag-icon.min.css">
    <link rel="stylesheet" th:href="@{/static/css/cs-skin-elastic.css}">
    <link rel="stylesheet" th:href="@{/static/css/style.css}">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>

    <style>
        .question-card {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .question-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
        }
        .question-body {
            padding: 15px;
        }
        .option-label {
            display: block;
            padding: 8px 15px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        .option-label:hover {
            background-color: #f8f9fa;
        }
        .option-input:checked + .option-label {
            background-color: #e3f2fd;
            border-color: #90caf9;
        }
        .timer-card {
            position: sticky;
            top: 20px;
        }
        .timer {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }
        .question-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        .question-nav-item {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        .question-nav-item.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .question-nav-item.answered {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
    </style>
</head>

<body>
    <!-- 右侧内容区域 -->
    <div id="right-panel" class="right-panel" style="margin-left: 0;">
        <!-- 头部 -->
        <header id="header" class="header">
            <div class="top-left">
                <div class="navbar-header">
                    <a class="navbar-brand" th:href="@{/main.html}"><img th:src="@{/static/images/logo.png}" alt="Logo"></a>
                    <a class="navbar-brand hidden" href="./"><img th:src="@{/static/images/logo2.png}" alt="Logo"></a>
                </div>
            </div>
            <div class="top-right">
                <div class="header-menu">
                    <div class="header-left">
                        <span style="margin-right: 10px;">考试：<b th:text="${exam.title}">考试标题</b></span>
                    </div>
                    <div class="user-area dropdown float-right">
                        <a href="#" class="dropdown-toggle active" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img class="user-avatar rounded-circle" th:src="@{/static/images/admin.jpg}" alt="User Avatar">
                        </a>
                        <div class="user-menu dropdown-menu">
                            <a class="nav-link" th:href="@{/main.html}"><i class="fa fa-home"></i>返回主页</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 内容区域 -->
        <div class="content">
            <div class="animated fadeIn">
                <div class="row">
                    <div class="col-lg-8">
                        <form id="examForm">
                            <input type="hidden" name="recordId" th:value="${record.recordId}">

                            <!-- 题目列表 -->
                            <div th:each="question, stat : ${questions}" th:id="'question-' + ${stat.index + 1}" class="question-card" th:style="${stat.index > 0 ? 'display: none;' : ''}">
                                <div class="question-header">
                                    <strong>第 <span th:text="${stat.index + 1}">1</span> 题 / 共 <span th:text="${questions.size()}">10</span> 题</strong>
                                    <span class="float-right" th:text="${question.score + '分'}">5分</span>
                                </div>
                                <div class="question-body">
                                    <p th:text="${question.questionContent}">题目内容</p>

                                    <!-- 单选题 -->
                                    <div th:if="${question.questionType == 1}" class="options">
                                        <input type="hidden" name="questionIds[]" th:value="${question.questionId}">

                                        <div class="option-group" th:attr="data-options=${question.options}" th:id="'options-' + ${question.questionId}">
                                            <!-- 选项将通过JavaScript动态生成 -->
                                        </div>
                                        <script th:inline="javascript">
                                            document.addEventListener('DOMContentLoaded', function() {
                                                try {
                                                    // 获取选项JSON字符串
                                                    var optionsJson = document.getElementById('options-' + [[${question.questionId}]]).getAttribute('data-options');
                                                    // 解析JSON
                                                    var optionsMap = JSON.parse(optionsJson);
                                                    // 获取选项容器
                                                    var optionsContainer = document.getElementById('options-' + [[${question.questionId}]]);
                                                    // 清空容器
                                                    optionsContainer.innerHTML = '';

                                                    // 遍历选项并创建HTML元素
                                                    for (var key in optionsMap) {
                                                        if (optionsMap.hasOwnProperty(key)) {
                                                            var optionItem = document.createElement('div');
                                                            optionItem.className = 'option-item';

                                                            var input = document.createElement('input');
                                                            input.type = 'radio';
                                                            input.name = 'answers[' + [[${stat.index}]] + ']';
                                                            input.value = key;
                                                            input.id = 'option-' + [[${question.questionId}]] + '-' + key;
                                                            input.className = 'option-input d-none';

                                                            var label = document.createElement('label');
                                                            label.htmlFor = 'option-' + [[${question.questionId}]] + '-' + key;
                                                            label.className = 'option-label';

                                                            var span = document.createElement('span');
                                                            span.textContent = key + '. ' + optionsMap[key];

                                                            label.appendChild(span);
                                                            optionItem.appendChild(input);
                                                            optionItem.appendChild(label);
                                                            optionsContainer.appendChild(optionItem);
                                                        }
                                                    }
                                                } catch (e) {
                                                    console.error('Error parsing options:', e);
                                                }
                                            });
                                        </script>
                                    </div>

                                    <!-- 多选题 -->
                                    <div th:if="${question.questionType == 2}" class="options">
                                        <input type="hidden" name="questionIds[]" th:value="${question.questionId}">

                                        <div class="alert alert-info">
                                            <strong>多选题提示：</strong> 请选择所有正确的选项。
                                        </div>

                                        <div class="option-group" th:attr="data-options=${question.options}" th:id="'options-multi-' + ${question.questionId}">
                                            <!-- 选项将通过JavaScript动态生成 -->
                                        </div>
                                        <script th:inline="javascript">
                                            document.addEventListener('DOMContentLoaded', function() {
                                                try {
                                                    // 获取选项JSON字符串
                                                    var optionsJson = document.getElementById('options-multi-' + [[${question.questionId}]]).getAttribute('data-options');
                                                    // 解析JSON
                                                    var optionsMap = JSON.parse(optionsJson);
                                                    // 获取选项容器
                                                    var optionsContainer = document.getElementById('options-multi-' + [[${question.questionId}]]);
                                                    // 清空容器
                                                    optionsContainer.innerHTML = '';

                                                    // 遍历选项并创建HTML元素
                                                    for (var key in optionsMap) {
                                                        if (optionsMap.hasOwnProperty(key)) {
                                                            var optionItem = document.createElement('div');
                                                            optionItem.className = 'option-item';

                                                            var input = document.createElement('input');
                                                            input.type = 'checkbox';
                                                            input.name = 'multiAnswers[' + [[${stat.index}]] + ']';
                                                            input.value = key;
                                                            input.id = 'option-multi-' + [[${question.questionId}]] + '-' + key;
                                                            input.className = 'option-input d-none';

                                                            var label = document.createElement('label');
                                                            label.htmlFor = 'option-multi-' + [[${question.questionId}]] + '-' + key;
                                                            label.className = 'option-label';

                                                            var span = document.createElement('span');
                                                            span.textContent = key + '. ' + optionsMap[key];

                                                            label.appendChild(span);
                                                            optionItem.appendChild(input);
                                                            optionItem.appendChild(label);
                                                            optionsContainer.appendChild(optionItem);
                                                        }
                                                    }
                                                } catch (e) {
                                                    console.error('Error parsing options:', e);
                                                }
                                            });
                                        </script>
                                    </div>

                                    <!-- 判断题 -->
                                    <div th:if="${question.questionType == 3}" class="options">
                                        <input type="hidden" name="questionIds[]" th:value="${question.questionId}">

                                        <div class="option-group">
                                            <div class="option-item">
                                                <input type="radio" th:name="'answers[' + ${stat.index} + ']'" value="T" th:id="'option-' + ${question.questionId} + '-T'" class="option-input d-none">
                                                <label th:for="'option-' + ${question.questionId} + '-T'" class="option-label">
                                                    <span>正确</span>
                                                </label>
                                            </div>
                                            <div class="option-item">
                                                <input type="radio" th:name="'answers[' + ${stat.index} + ']'" value="F" th:id="'option-' + ${question.questionId} + '-F'" class="option-input d-none">
                                                <label th:for="'option-' + ${question.questionId} + '-F'" class="option-label">
                                                    <span>错误</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 填空题 -->
                                    <div th:if="${question.questionType == 4}" class="options">
                                        <input type="hidden" name="questionIds[]" th:value="${question.questionId}">

                                        <div class="form-group">
                                            <input type="text" class="form-control" th:name="'answers[' + ${stat.index} + ']'" placeholder="请输入答案">
                                        </div>
                                    </div>

                                    <!-- 简答题 -->
                                    <div th:if="${question.questionType == 5}" class="options">
                                        <input type="hidden" name="questionIds[]" th:value="${question.questionId}">

                                        <div class="form-group">
                                            <textarea class="form-control" th:name="'answers[' + ${stat.index} + ']'" rows="5" placeholder="请输入答案"></textarea>
                                        </div>
                                    </div>

                                    <!-- 导航按钮 -->
                                    <div class="mt-4 d-flex justify-content-between">
                                        <button type="button" class="btn btn-secondary prev-btn" th:if="${stat.index > 0}">上一题</button>
                                        <div class="flex-grow-1"></div>
                                        <button type="button" class="btn btn-primary next-btn" th:if="${!stat.last}">下一题</button>
                                        <button type="button" class="btn btn-success submit-btn" th:if="${stat.last}">提交考试</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="col-lg-4">
                        <div class="card timer-card">
                            <div class="card-header">
                                <strong>考试信息</strong>
                            </div>
                            <div class="card-body">
                                <div class="timer" id="timer">00:00:00</div>
                                <div class="progress mb-3">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="timer-progress"></div>
                                </div>

                                <div class="mb-3">
                                    <strong>题目导航</strong>
                                    <div class="question-nav mt-2" id="question-nav">
                                        <div th:each="question, stat : ${questions}" th:data-index="${stat.index + 1}" class="question-nav-item" th:classappend="${stat.index == 0 ? 'active' : ''}">
                                            <span th:text="${stat.index + 1}">1</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mb-2">
                                    <span><i class="fa fa-circle text-primary"></i> 当前题目</span>
                                    <span><i class="fa fa-circle text-success"></i> 已答题目</span>
                                </div>

                                <button type="button" class="btn btn-success btn-block submit-btn">提交考试</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.content -->

        <div class="clearfix"></div>
    </div>
    <!-- /#right-panel -->

    <!-- 确认提交模态框 -->
    <div class="modal fade" id="submitModal" tabindex="-1" role="dialog" aria-labelledby="submitModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="submitModalLabel">确认提交</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>您确定要提交考试吗？提交后将无法修改答案。</p>
                    <div id="unanswered-warning" class="alert alert-warning" style="display: none;">
                        <strong>警告：</strong> 您还有 <span id="unanswered-count">0</span> 道题目未作答。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm-submit">确认提交</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-match-height@0.7.2/dist/jquery.matchHeight.min.js"></script>
    <script th:src="@{/static/js/main.js}"></script>

    <script th:inline="javascript">
        // 确保jQuery已加载
        window.onload = function() {
            if (typeof jQuery === 'undefined') {
                console.error('jQuery is not loaded!');
                alert('页面加载出错，请刷新重试');
                return;
            }

            jQuery(document).ready(function($) {
            // 考试时长（分钟）
            const examDuration = [[${exam.duration}]];
            // 考试开始时间
            const startTime = new Date([[${record.startTime}]]);
            // 当前时间
            const now = new Date();
            // 已经过去的时间（秒）
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            // 剩余时间（秒）
            let remainingSeconds = examDuration * 60 - elapsedSeconds;

            // 如果剩余时间小于0，则设置为0
            if (remainingSeconds < 0) {
                remainingSeconds = 0;
            }

            // 更新计时器
            function updateTimer() {
                if (remainingSeconds <= 0) {
                    // 时间到，自动提交
                    clearInterval(timerInterval);
                    submitExam();
                    return;
                }

                const hours = Math.floor(remainingSeconds / 3600);
                const minutes = Math.floor((remainingSeconds % 3600) / 60);
                const seconds = remainingSeconds % 60;

                $('#timer').text(
                    (hours < 10 ? '0' + hours : hours) + ':' +
                    (minutes < 10 ? '0' + minutes : minutes) + ':' +
                    (seconds < 10 ? '0' + seconds : seconds)
                );

                // 更新进度条
                const progress = 100 - (remainingSeconds / (examDuration * 60) * 100);
                $('#timer-progress').css('width', progress + '%');

                remainingSeconds--;
            }

            // 初始化计时器
            updateTimer();
            const timerInterval = setInterval(updateTimer, 1000);

            // 初始化题目显示
            console.log('初始化题目显示');
            $('.question-card').hide();
            $('#question-1').show();
            $('.question-nav-item').removeClass('active');
            $('.question-nav-item[data-index="1"]').addClass('active');

            // 从localStorage加载保存的答案
            loadAnswersFromLocalStorage();

            // 初始化调试信息
            console.log('题目卡片数量:', $('.question-card').length);
            console.log('导航项数量:', $('.question-nav-item').length);

            $('.question-card').each(function(index) {
                console.log('题目卡片ID:', $(this).attr('id'), '是否可见:', $(this).is(':visible'));
            });

            $('.question-nav-item').each(function(index) {
                console.log('导航项索引:', $(this).data('index'), '是否激活:', $(this).hasClass('active'));
            });

            // 题目导航
            $(document).on('click', '.question-nav-item', function() {
                const index = $(this).data('index');
                console.log('Navigation clicked:', index);

                // 直接使用jQuery选择器显示对应题目
                $('.question-card').hide();
                $('#question-' + index).show();

                // 更新导航状态
                $('.question-nav-item').removeClass('active');
                $(this).addClass('active');

                console.log('题目是否显示:', $('#question-' + index).is(':visible'));
            });

            // 上一题按钮
            $(document).on('click', '.prev-btn', function() {
                // 获取当前显示的题目ID
                const currentQuestionId = $('.question-card:visible').attr('id');
                console.log('当前题目ID (上一题):', currentQuestionId);

                // 从ID中提取索引，例如从"question-1"中提取"1"
                const currentIndex = parseInt(currentQuestionId.split('-')[1]);
                const prevIndex = currentIndex - 1;
                console.log('当前索引:', currentIndex, '上一题索引:', prevIndex);

                // 直接使用jQuery选择器显示对应题目
                $('.question-card').hide();
                $('#question-' + prevIndex).show();

                // 更新导航状态
                $('.question-nav-item').removeClass('active');
                $('.question-nav-item[data-index="' + prevIndex + '"]').addClass('active');

                console.log('上一题是否显示:', $('#question-' + prevIndex).is(':visible'));
            });

            // 下一题按钮
            $(document).on('click', '.next-btn', function() {
                // 获取当前显示的题目ID
                const currentQuestionId = $('.question-card:visible').attr('id');
                console.log('当前题目ID (下一题):', currentQuestionId);

                // 从ID中提取索引，例如从"question-1"中提取"1"
                const currentIndex = parseInt(currentQuestionId.split('-')[1]);
                const nextIndex = currentIndex + 1;
                console.log('当前索引:', currentIndex, '下一题索引:', nextIndex);

                // 直接使用jQuery选择器显示对应题目
                $('.question-card').hide();
                $('#question-' + nextIndex).show();

                // 更新导航状态
                $('.question-nav-item').removeClass('active');
                $('.question-nav-item[data-index="' + nextIndex + '"]').addClass('active');

                console.log('下一题是否显示:', $('#question-' + nextIndex).is(':visible'));
            });

            // 保存答案到localStorage
            function saveAnswerToLocalStorage(questionIndex, answer, questionType) {
                const recordId = [[${record.recordId}]];
                const storageKey = 'exam_' + recordId;

                // 获取已保存的答案，如果没有则创建新对象
                let savedAnswers = localStorage.getItem(storageKey);
                let answersObj = savedAnswers ? JSON.parse(savedAnswers) : {};

                // 保存答案
                answersObj[questionIndex] = {
                    answer: answer,
                    type: questionType
                };

                // 保存回localStorage
                localStorage.setItem(storageKey, JSON.stringify(answersObj));
                console.log('已保存答案:', questionIndex, answer, questionType);
            }

            // 从localStorage加载答案
            function loadAnswersFromLocalStorage() {
                const recordId = [[${record.recordId}]];
                const storageKey = 'exam_' + recordId;

                let savedAnswers = localStorage.getItem(storageKey);
                if (!savedAnswers) return;

                let answersObj = JSON.parse(savedAnswers);
                console.log('从localStorage加载答案:', answersObj);

                // 遍历所有题目，恢复答案
                $('.question-card').each(function() {
                    const questionId = $(this).attr('id');
                    const questionIndex = questionId.split('-')[1];

                    if (answersObj[questionIndex]) {
                        const savedAnswer = answersObj[questionIndex].answer;
                        const questionType = answersObj[questionIndex].type;

                        if (questionType === 'radio') {
                            // 单选题或判断题
                            $(this).find('input[type="radio"][value="' + savedAnswer + '"]').prop('checked', true);
                        } else if (questionType === 'checkbox') {
                            // 多选题
                            if (savedAnswer) {
                                const options = savedAnswer.split(',');
                                options.forEach(option => {
                                    $(this).find('input[type="checkbox"][value="' + option + '"]').prop('checked', true);
                                });
                            }
                        } else if (questionType === 'text') {
                            // 填空题
                            $(this).find('input[type="text"]').val(savedAnswer);
                        } else if (questionType === 'textarea') {
                            // 简答题
                            $(this).find('textarea').val(savedAnswer);
                        }

                        // 更新导航状态
                        if (savedAnswer) {
                            $('.question-nav-item[data-index="' + questionIndex + '"]').addClass('answered');
                        }
                    }
                });
            }

            // 监听选项变化，更新导航状态并保存答案
            $(document).on('change', '.option-input, input[type="text"], textarea', function() {
                // 获取题目ID
                const questionCard = $(this).closest('.question-card');
                const questionId = questionCard.attr('id');
                // 从ID中提取索引，例如从"question-1"中提取"1"
                const questionIndex = questionId.split('-')[1];
                console.log('Question answered:', questionIndex);

                // 获取答案
                let answer = '';
                let questionType = '';

                if ($(this).is('input[type="checkbox"]')) {
                    // 多选题
                    const selectedOptions = [];
                    questionCard.find('input[type="checkbox"]:checked').each(function() {
                        selectedOptions.push($(this).val());
                    });
                    answer = selectedOptions.join(',');
                    questionType = 'checkbox';
                } else if ($(this).is('input[type="radio"]')) {
                    // 单选题或判断题
                    answer = $(this).val();
                    questionType = 'radio';
                } else if ($(this).is('input[type="text"]')) {
                    // 填空题
                    answer = $(this).val();
                    questionType = 'text';
                } else if ($(this).is('textarea')) {
                    // 简答题
                    answer = $(this).val();
                    questionType = 'textarea';
                }

                // 保存答案
                saveAnswerToLocalStorage(questionIndex, answer, questionType);

                // 更新导航状态
                $('.question-nav-item[data-index="' + questionIndex + '"]').addClass('answered');
            });

            // 监听文本输入，实时更新导航状态和保存答案
            $(document).on('input', 'input[type="text"], textarea', function() {
                // 获取题目ID
                const questionCard = $(this).closest('.question-card');
                const questionId = questionCard.attr('id');
                // 从ID中提取索引，例如从"question-1"中提取"1"
                const questionIndex = questionId.split('-')[1];

                // 获取答案
                const answer = $(this).val();
                const questionType = $(this).is('textarea') ? 'textarea' : 'text';

                // 保存答案
                saveAnswerToLocalStorage(questionIndex, answer, questionType);

                // 如果有内容，则标记为已答题
                if (answer && answer.trim() !== '') {
                    $('.question-nav-item[data-index="' + questionIndex + '"]').addClass('answered');
                } else {
                    $('.question-nav-item[data-index="' + questionIndex + '"]').removeClass('answered');
                }
            });

            // 在提交考试前清除localStorage中的答案
            function clearLocalStorageAnswers() {
                const recordId = [[${record.recordId}]];
                const storageKey = 'exam_' + recordId;
                localStorage.removeItem(storageKey);
                console.log('已清除localStorage中的答案');
            }

            // 提交按钮点击事件
            $(document).on('click', '.submit-btn', function() {
                // 检查未答题数量
                const totalQuestions = [[${questions.size()}]];
                const answeredQuestions = $('.question-nav-item.answered').length;
                const unansweredCount = totalQuestions - answeredQuestions;

                if (unansweredCount > 0) {
                    $('#unanswered-count').text(unansweredCount);
                    $('#unanswered-warning').show();
                } else {
                    $('#unanswered-warning').hide();
                }

                $('#submitModal').modal('show');
            });

            // 确认提交
            $(document).on('click', '#confirm-submit', function() {
                submitExam();
            });

            // 提交考试
            function submitExam() {
                // 清除localStorage中的答案
                clearLocalStorageAnswers();

                // 准备提交数据
                const formData = new FormData(document.getElementById('examForm'));
                const recordId = [[${record.recordId}]];

                // 收集所有题目ID和答案
                const questionIds = [];
                const answers = [];

                $('.question-card').each(function(index) {
                    const questionId = $(this).find('input[name="questionIds[]"]').val();
                    questionIds.push(questionId);

                    // 获取题目类型 - 从DOM元素中获取
                    const questionCard = $(this);
                    let answer = '';

                    // 检查是否包含多选题选项
                    if (questionCard.find('input[type="checkbox"]').length > 0) { // 多选题
                        // 获取所有选中的复选框值
                        const selectedOptions = [];
                        $(this).find('input[type="checkbox"]:checked').each(function() {
                            selectedOptions.push($(this).val());
                        });
                        // 将选项用逗号连接
                        answer = selectedOptions.join(',');
                        console.log('多选题答案:', answer, '题目ID:', questionId);
                    } else if (questionCard.find('textarea').length > 0) { // 简答题
                        // 获取文本区域的值
                        answer = questionCard.find('textarea').val() || '';
                    } else if (questionCard.find('input[type="text"]').length > 0) { // 填空题
                        // 获取文本输入的值
                        answer = questionCard.find('input[type="text"]').val() || '';
                    } else { // 单选题或判断题
                        // 获取选中的单选按钮值
                        answer = questionCard.find('input[type="radio"]:checked').val() || '';
                    }

                    answers.push(answer);
                });

                // 发送AJAX请求
                $.ajax({
                    url: '/submitExam',
                    type: 'POST',
                    data: {
                        recordId: recordId,
                        'questionIds[]': questionIds,
                        'answers[]': answers
                    },
                    success: function(response) {
                        if (response.success) {
                            window.location.href = '/examResult/' + recordId;
                        } else {
                            alert('提交失败：' + response.message);
                        }
                    },
                    error: function() {
                        alert('提交失败，请稍后重试');
                    }
                });
            }

            // 禁用浏览器后退按钮
            history.pushState(null, null, location.href);
            window.onpopstate = function() {
                history.go(1);
                alert('考试进行中，请勿返回上一页！');
            };

            // 禁用F5刷新
            document.onkeydown = function(e) {
                if (e.keyCode === 116) {
                    e.preventDefault();
                    alert('考试进行中，请勿刷新页面！');
                    return false;
                }
            };

            // 关闭窗口提示
            window.onbeforeunload = function() {
                return '考试进行中，关闭页面将导致答案丢失！';
            };
            });
        };
    </script>
</body>
</html>
