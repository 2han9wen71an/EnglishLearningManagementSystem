<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>考试结果 - 英语学习管理系统</title>
    <meta name="description" content="考试结果">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="https://i.imgur.com/QRAUqs9.png">
    <link rel="shortcut icon" href="https://i.imgur.com/QRAUqs9.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lykmapipo/themify-icons@0.1.2/css/themify-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pixeden-stroke-7-icon@1.2.3/pe-icon-7-stroke/dist/pe-icon-7-stroke.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.0/css/flag-icon.min.css">
    <link rel="stylesheet" th:href="@{/static/css/cs-skin-elastic.css}">
    <link rel="stylesheet" th:href="@{/static/css/style.css}">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>

    <style>
        .question-card {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .question-header {
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
        }
        .question-body {
            padding: 15px;
        }
        .option-label {
            display: block;
            padding: 8px 15px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .option-correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .option-incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .option-selected {
            border-width: 2px;
        }
        .analysis-box {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 3px;
            margin-top: 15px;
        }
        .result-summary {
            position: sticky;
            top: 20px;
        }
        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 36px;
            font-weight: bold;
            color: white;
        }
        .score-pass {
            background-color: #28a745;
        }
        .score-fail {
            background-color: #dc3545;
        }
    </style>
</head>

<body>
    <!-- 左侧菜单栏 -->
    <div th:replace="common/leftbar::leftbar"></div>

    <!-- 右侧内容区域 -->
    <div id="right-panel" class="right-panel">
        <!-- 头部 -->
        <div th:replace="common/header::header"></div>

        <!-- 内容区域 -->
        <div class="content">
            <div class="animated fadeIn">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <strong class="card-title">考试详情</strong>
                                <a class="btn btn-outline-secondary float-right" th:href="@{/viewExams}">返回列表</a>
                            </div>
                            <div class="card-body">
                                <h4 th:text="${exam.title}">考试标题</h4>
                                <p th:text="${exam.description}">考试描述</p>

                                <!-- 答题详情 -->
                                <div class="mt-4">
                                    <h5>答题详情</h5>

                                    <div th:each="answer, stat : ${answers}" class="question-card">
                                        <div th:class="'question-header ' + (${answer.scoringStatus == 1 ? 'bg-warning text-dark' : (answer.scoringStatus == 3 ? 'bg-info text-white' : (answer.isCorrect == 1 ? 'bg-success text-white' : 'bg-danger text-white'))})">
                                            <strong>第 <span th:text="${stat.index + 1}">1</span> 题</strong>
                                            <span class="float-right" th:if="${answer.scoringStatus == 1 && answer.questionType == 5}">AI评分进行中...</span>
                                            <span class="float-right" th:if="${answer.scoringStatus == 1 && answer.questionType != 5}">待评分</span>
                                            <span class="float-right" th:if="${answer.scoringStatus == 3}">AI评分：<span th:text="${answer.score}">3</span>分 (待确认)</span>
                                            <span class="float-right" th:if="${answer.scoringStatus == 0 || answer.scoringStatus == 2}" th:text="${answer.isCorrect == 1 ? '正确 +' + answer.score + '分' : '错误 +0分'}">正确 +5分</span>
                                        </div>
                                        <div class="question-body">
                                            <p th:text="${answer.questionContent}">题目内容</p>

                                            <!-- 单选题 -->
                                            <div th:if="${answer.questionType == 1}" class="options">
                                                <div class="option-group" th:attr="data-options=${answer.options}, data-correct=${answer.correctAnswer}, data-user=${answer.userAnswer}" th:id="'options-' + ${answer.questionId}">
                                                    <!-- 选项将通过JavaScript动态生成 -->
                                                </div>
                                                <script th:inline="javascript">
                                                    document.addEventListener('DOMContentLoaded', function() {
                                                        try {
                                                            // 获取选项JSON字符串和答案信息
                                                            var container = document.getElementById('options-' + [[${answer.questionId}]]);
                                                            var optionsJson = container.getAttribute('data-options');
                                                            var correctAnswer = container.getAttribute('data-correct');
                                                            var userAnswer = container.getAttribute('data-user');

                                                            // 解析JSON
                                                            var optionsMap = JSON.parse(optionsJson);
                                                            // 清空容器
                                                            container.innerHTML = '';

                                                            // 遍历选项并创建HTML元素
                                                            for (var key in optionsMap) {
                                                                if (optionsMap.hasOwnProperty(key)) {
                                                                    var optionItem = document.createElement('div');
                                                                    optionItem.className = 'option-item';

                                                                    var optionLabel = document.createElement('div');
                                                                    var labelClasses = ['option-label'];

                                                                    // 添加样式类
                                                                    if (key === correctAnswer) {
                                                                        labelClasses.push('option-correct');
                                                                    }
                                                                    if (key === userAnswer && key !== correctAnswer) {
                                                                        labelClasses.push('option-incorrect');
                                                                    }
                                                                    if (key === userAnswer) {
                                                                        labelClasses.push('option-selected');
                                                                    }

                                                                    optionLabel.className = labelClasses.join(' ');

                                                                    // 选项内容
                                                                    var contentSpan = document.createElement('span');
                                                                    contentSpan.textContent = key + '. ' + optionsMap[key];
                                                                    optionLabel.appendChild(contentSpan);

                                                                    // 添加标记
                                                                    if (key === correctAnswer) {
                                                                        var correctSpan = document.createElement('span');
                                                                        correctSpan.className = 'float-right text-success';
                                                                        correctSpan.innerHTML = '<i class="fa fa-check"></i> 正确答案';
                                                                        optionLabel.appendChild(correctSpan);
                                                                    }

                                                                    if (key === userAnswer && key !== correctAnswer) {
                                                                        var incorrectSpan = document.createElement('span');
                                                                        incorrectSpan.className = 'float-right text-danger';
                                                                        incorrectSpan.innerHTML = '<i class="fa fa-times"></i> 您的答案';
                                                                        optionLabel.appendChild(incorrectSpan);
                                                                    }

                                                                    if (key === userAnswer && key === correctAnswer) {
                                                                        var correctUserSpan = document.createElement('span');
                                                                        correctUserSpan.className = 'float-right text-success';
                                                                        correctUserSpan.innerHTML = '<i class="fa fa-check"></i> 您的答案';
                                                                        optionLabel.appendChild(correctUserSpan);
                                                                    }

                                                                    optionItem.appendChild(optionLabel);
                                                                    container.appendChild(optionItem);
                                                                }
                                                            }
                                                        } catch (e) {
                                                            console.error('Error parsing options:', e);
                                                        }
                                                    });
                                                </script>
                                            </div>

                                            <!-- AI评分解释 -->
                                            <div class="analysis-box" th:if="${answer.scoringStatus == 3 && answer.aiScoreExplanation != null && !answer.aiScoreExplanation.isEmpty()}" style="background-color: #e3f2fd;">
                                                <h6><i class="fa fa-robot"></i> AI评分解释</h6>
                                                <div th:utext="${answer.aiScoreExplanation}">AI评分解释内容</div>
                                            </div>

                                            <!-- 解析 -->
                                            <div class="analysis-box" th:if="${answer.analysis != null && !answer.analysis.isEmpty()}">
                                                <h6><i class="fa fa-info-circle"></i> 解析</h6>
                                                <p th:text="${answer.analysis}">题目解析</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card result-summary">
                            <div class="card-header">
                                <strong>考试结果</strong>
                            </div>
                            <div class="card-body text-center">
                                <div th:class="'score-circle ' + (${record.score >= exam.passScore ? 'score-pass' : 'score-fail'})">
                                    <span th:text="${record.score}">85</span>
                                </div>

                                <div class="mb-3">
                                    <h5 th:text="${record.score >= exam.passScore ? '恭喜，您已通过考试！' : '很遗憾，您未通过考试。'}">恭喜，您已通过考试！</h5>
                                    <p>总分：<span th:text="${exam.totalScore}">100</span> 分，及格分：<span th:text="${exam.passScore}">60</span> 分</p>
                                    <div class="alert alert-warning" th:if="${record.status == 1}">
                                        <strong>注意：</strong> 您的考试中包含需要人工评分或AI评分待确认的题目，最终成绩可能会有变动。
                                    </div>
                                    <div class="alert alert-info" th:if="${record.status == 1}">
                                        <strong>提示：</strong> 简答题正在由AI进行初步评分，评分完成后会显示AI评分建议。请稍后刷新页面查看最新评分状态。
                                    </div>
                                </div>

                                <div class="progress mb-3">
                                    <div class="progress-bar" role="progressbar" th:style="'width: ' + ${record.score / exam.totalScore * 100} + '%'" th:text="${record.score + '/' + exam.totalScore}">85/100</div>
                                </div>

                                <table class="table table-bordered">
                                    <tr>
                                        <th>开始时间</th>
                                        <td th:text="${#dates.format(record.startTime, 'yyyy-MM-dd HH:mm:ss')}">2023-01-01 10:00:00</td>
                                    </tr>
                                    <tr>
                                        <th>结束时间</th>
                                        <td th:text="${#dates.format(record.endTime, 'yyyy-MM-dd HH:mm:ss')}">2023-01-01 10:30:00</td>
                                    </tr>
                                    <tr>
                                        <th>用时</th>
                                        <td th:with="duration = ${T(java.time.Duration).between(record.startTime.toInstant(), record.endTime.toInstant())}">
                                            <span th:text="${duration.toMinutes() + '分' + (duration.getSeconds() % 60) + '秒'}">30分00秒</span>
                                        </td>
                                    </tr>
                                </table>

                                <div class="mt-3">
                                    <a th:href="@{'/viewExam/' + ${exam.examId}}" class="btn btn-primary">返回考试详情</a>
                                    <a th:href="@{'/startExam/' + ${exam.examId}}" class="btn btn-outline-secondary">重新考试</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.content -->

        <div class="clearfix"></div>
        <!-- 页脚 -->
        <div th:replace="common/footer::footer"></div>
    </div>
    <!-- /#right-panel -->

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-match-height@0.7.2/dist/jquery.matchHeight.min.js"></script>
    <script th:src="@{/static/js/main.js}"></script>

    <script>
        // 确保jQuery已加载
        window.onload = function() {
            if (typeof jQuery === 'undefined') {
                console.error('jQuery is not loaded!');
                alert('页面加载出错，请刷新重试');
                return;
            }

            // 检查是否有AI评分进行中的题目
            const hasAiScoringInProgress = jQuery('.question-header:contains("AI评分进行中")').length > 0;

            // 如果有AI评分进行中的题目，设置自动刷新
            if (hasAiScoringInProgress) {
                console.log('检测到AI评分进行中，将在30秒后自动刷新页面');

                // 显示倒计时
                const refreshInfoDiv = jQuery('<div class="alert alert-info mt-3 text-center">')
                    .html('<strong>AI评分进行中</strong>：页面将在 <span id="refresh-countdown">30</span> 秒后自动刷新以获取最新评分结果')
                    .appendTo('.result-summary');

                // 倒计时
                let countdown = 30;
                const countdownInterval = setInterval(function() {
                    countdown--;
                    jQuery('#refresh-countdown').text(countdown);

                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        location.reload();
                    }
                }, 1000);

                // 添加手动刷新按钮
                jQuery('<button class="btn btn-sm btn-info mt-2">')
                    .text('立即刷新')
                    .on('click', function() {
                        location.reload();
                    })
                    .appendTo(refreshInfoDiv);
            }
        };
    </script>
</body>
</html>
