<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>编辑题目 - 英语学习管理系统</title>
    <meta name="description" content="编辑题目">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="https://i.imgur.com/QRAUqs9.png">
    <link rel="shortcut icon" href="https://i.imgur.com/QRAUqs9.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lykmapipo/themify-icons@0.1.2/css/themify-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pixeden-stroke-7-icon@1.2.3/pe-icon-7-stroke/dist/pe-icon-7-stroke.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.0/css/flag-icon.min.css">
    <link rel="stylesheet" th:href="@{/static/css/cs-skin-elastic.css}">
    <link rel="stylesheet" th:href="@{/static/css/style.css}">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>
</head>

<body>
    <!-- 左侧菜单栏 -->
    <div th:replace="common/admin-leftbar::leftbar"></div>

    <!-- 右侧内容区域 -->
    <div id="right-panel" class="right-panel">
        <!-- 头部 -->
        <div th:replace="common/admin-header::header"></div>

        <!-- 内容区域 -->
        <div class="content mt-3">
            <div class="animated fadeIn">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <strong class="card-title" th:text="${question.examTitle + ' - 编辑题目'}">考试标题 - 编辑题目</strong>
                                <a class="btn btn-secondary float-right" th:href="@{'/admin/viewExamQuestions/' + ${question.examId}}">
                                    <i class="fa fa-arrow-left"></i> 返回题目列表
                                </a>
                            </div>
                            <div class="card-body">
                                <form id="questionForm" th:action="@{/admin/editQuestion}" method="post">
                                    <input type="hidden" name="questionId" th:value="${question.questionId}">
                                    <input type="hidden" name="examId" th:value="${question.examId}">

                                    <div class="form-group">
                                        <label for="questionType">题目类型</label>
                                        <select class="form-control" id="questionType" name="questionType" required th:value="${question.questionType}">
                                            <option value="1" th:selected="${question.questionType == 1}">单选题</option>
                                            <option value="2" th:selected="${question.questionType == 2}">多选题</option>
                                            <option value="3" th:selected="${question.questionType == 3}">判断题</option>
                                            <option value="4" th:selected="${question.questionType == 4}">填空题</option>
                                            <option value="5" th:selected="${question.questionType == 5}">简答题</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="questionContent">题目内容</label>
                                        <textarea class="form-control" id="questionContent" name="questionContent" rows="3" required th:text="${question.questionContent}"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label for="score">分值</label>
                                        <input type="number" class="form-control" id="score" name="score" min="1" max="100" th:value="${question.score}" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="orderNum">题目顺序</label>
                                        <input type="number" class="form-control" id="orderNum" name="orderNum" min="1" th:value="${question.orderNum}" required>
                                    </div>

                                    <!-- 单选题选项 -->
                                    <div id="singleChoiceOptions" class="option-container" th:style="${question.questionType != 1 ? 'display: none;' : ''}">
                                        <h5>选项</h5>
                                        <div class="form-group">
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text">A</div>
                                                </div>
                                                <input type="text" class="form-control option-input" data-option="A" placeholder="选项A内容" th:value="${optionsMap != null && optionsMap.containsKey('A') ? optionsMap.get('A') : ''}">
                                            </div>
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text">B</div>
                                                </div>
                                                <input type="text" class="form-control option-input" data-option="B" placeholder="选项B内容" th:value="${optionsMap != null && optionsMap.containsKey('B') ? optionsMap.get('B') : ''}">
                                            </div>
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text">C</div>
                                                </div>
                                                <input type="text" class="form-control option-input" data-option="C" placeholder="选项C内容" th:value="${optionsMap != null && optionsMap.containsKey('C') ? optionsMap.get('C') : ''}">
                                            </div>
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text">D</div>
                                                </div>
                                                <input type="text" class="form-control option-input" data-option="D" placeholder="选项D内容" th:value="${optionsMap != null && optionsMap.containsKey('D') ? optionsMap.get('D') : ''}">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="correctAnswer">正确答案</label>
                                            <select class="form-control" id="correctAnswer" name="correctAnswer">
                                                <option value="A" th:selected="${question.correctAnswer == 'A'}">A</option>
                                                <option value="B" th:selected="${question.correctAnswer == 'B'}">B</option>
                                                <option value="C" th:selected="${question.correctAnswer == 'C'}">C</option>
                                                <option value="D" th:selected="${question.correctAnswer == 'D'}">D</option>
                                            </select>
                                        </div>

                                        <!-- 隐藏字段，用于存储JSON格式的选项 -->
                                        <input type="hidden" id="options" name="options" th:value="${question.options}">
                                    </div>

                                    <!-- 多选题选项 -->
                                    <div id="multiChoiceOptions" class="option-container" th:style="${question.questionType != 2 ? 'display: none;' : ''}">
                                        <h5>选项</h5>
                                        <div class="form-group">
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text">
                                                        <input type="checkbox" class="multi-option-checkbox" data-option="A" th:checked="${question.correctAnswer != null && question.correctAnswer.contains('A')}">
                                                    </div>
                                                </div>
                                                <input type="text" class="form-control option-input multi-option-input" data-option="A" placeholder="选项A内容" th:value="${optionsMap != null && optionsMap.containsKey('A') ? optionsMap.get('A') : ''}">
                                            </div>
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text">
                                                        <input type="checkbox" class="multi-option-checkbox" data-option="B" th:checked="${question.correctAnswer != null && question.correctAnswer.contains('B')}">
                                                    </div>
                                                </div>
                                                <input type="text" class="form-control option-input multi-option-input" data-option="B" placeholder="选项B内容" th:value="${optionsMap != null && optionsMap.containsKey('B') ? optionsMap.get('B') : ''}">
                                            </div>
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text">
                                                        <input type="checkbox" class="multi-option-checkbox" data-option="C" th:checked="${question.correctAnswer != null && question.correctAnswer.contains('C')}">
                                                    </div>
                                                </div>
                                                <input type="text" class="form-control option-input multi-option-input" data-option="C" placeholder="选项C内容" th:value="${optionsMap != null && optionsMap.containsKey('C') ? optionsMap.get('C') : ''}">
                                            </div>
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text">
                                                        <input type="checkbox" class="multi-option-checkbox" data-option="D" th:checked="${question.correctAnswer != null && question.correctAnswer.contains('D')}">
                                                    </div>
                                                </div>
                                                <input type="text" class="form-control option-input multi-option-input" data-option="D" placeholder="选项D内容" th:value="${optionsMap != null && optionsMap.containsKey('D') ? optionsMap.get('D') : ''}">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label>已选答案：<span id="selectedOptionsDisplay"></span></label>
                                        </div>

                                        <!-- 隐藏字段，用于存储多选题的正确答案 -->
                                        <input type="hidden" id="multiCorrectAnswer" name="correctAnswer" th:value="${question.correctAnswer}">
                                    </div>

                                    <!-- 判断题选项 -->
                                    <div id="judgementOptions" class="option-container" th:style="${question.questionType != 3 ? 'display: none;' : ''}">
                                        <div class="form-group">
                                            <label for="judgementAnswer">正确答案</label>
                                            <select class="form-control" id="judgementAnswer" name="correctAnswer">
                                                <option value="T" th:selected="${question.correctAnswer == 'T'}">正确</option>
                                                <option value="F" th:selected="${question.correctAnswer == 'F'}">错误</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- 填空题和简答题 -->
                                    <div id="textAnswerOptions" class="option-container" th:style="${question.questionType != 4 && question.questionType != 5 ? 'display: none;' : ''}">
                                        <div class="form-group">
                                            <label for="textAnswer">正确答案</label>
                                            <textarea class="form-control" id="textAnswer" name="correctAnswer" rows="3" th:text="${question.correctAnswer}"></textarea>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="analysis">解析</label>
                                        <textarea class="form-control" id="analysis" name="analysis" rows="3" th:text="${question.analysis}"></textarea>
                                    </div>

                                    <button type="submit" class="btn btn-primary">保存题目</button>
                                    <a th:href="@{'/admin/viewExamQuestions/' + ${question.examId}}" class="btn btn-secondary">取消</a>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.content -->

        <div class="clearfix"></div>
        <!-- 页脚 -->
        <div th:replace="common/footer::footer"></div>
    </div>
    <!-- /#right-panel -->

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-match-height@0.7.2/dist/jquery.matchHeight.min.js"></script>
    <script th:src="@{/static/js/main.js}"></script>

    <script th:inline="javascript">
        jQuery(document).ready(function($) {
            // 解析选项JSON
            const optionsJson = [[${question.options}]];
            let optionsMap = {};

            try {
                if (optionsJson) {
                    optionsMap = JSON.parse(optionsJson);
                }
            } catch (e) {
                console.error('Error parsing options:', e);
            }

            // 初始化
            updateMultiCorrectAnswer();

            // 题目类型切换
            $('#questionType').change(function() {
                const type = $(this).val();
                $('.option-container').hide();

                switch(type) {
                    case '1': // 单选题
                        $('#singleChoiceOptions').show();
                        break;
                    case '2': // 多选题
                        $('#multiChoiceOptions').show();
                        updateMultiCorrectAnswer(); // 更新多选题显示
                        break;
                    case '3': // 判断题
                        $('#judgementOptions').show();
                        break;
                    case '4': // 填空题
                    case '5': // 简答题
                        $('#textAnswerOptions').show();
                        break;
                }
            });

            // 多选题选项变化
            $('.multi-option-checkbox').change(function() {
                updateMultiCorrectAnswer();
            });

            // 更新多选题正确答案
            function updateMultiCorrectAnswer() {
                const selectedOptions = [];
                $('.multi-option-checkbox:checked').each(function() {
                    selectedOptions.push($(this).data('option'));
                });
                $('#multiCorrectAnswer').val(selectedOptions.join(','));

                // 更新显示
                $('#selectedOptionsDisplay').text(selectedOptions.join(', ') || '无');
            }

            // 表单提交前处理
            $('#questionForm').submit(function(e) {
                e.preventDefault(); // 阻止默认提交

                // 处理选项
                const type = $('#questionType').val();

                // 清除所有答案字段的name属性
                $('#correctAnswer').removeAttr('name');
                $('#multiCorrectAnswer').removeAttr('name');
                $('#judgementAnswer').removeAttr('name');
                $('#textAnswer').removeAttr('name');

                // 根据题型设置正确的答案字段
                if (type === '1') {
                    $('#correctAnswer').attr('name', 'correctAnswer');

                    // 处理选项
                    const options = {};
                    $('#singleChoiceOptions .option-input').each(function() {
                        const option = $(this).data('option');
                        const content = $(this).val().trim();
                        if (content) {
                            options[option] = content;
                        }
                    });
                    $('#options').val(JSON.stringify(options));
                }
                else if (type === '2') {
                    $('#multiCorrectAnswer').attr('name', 'correctAnswer');
                    updateMultiCorrectAnswer();

                    // 处理选项
                    const options = {};
                    $('#multiChoiceOptions .option-input').each(function() {
                        const option = $(this).data('option');
                        const content = $(this).val().trim();
                        if (content) {
                            options[option] = content;
                        }
                    });
                    $('#options').val(JSON.stringify(options));
                }
                else if (type === '3') {
                    $('#judgementAnswer').attr('name', 'correctAnswer');
                }
                else if (type === '4' || type === '5') {
                    $('#textAnswer').attr('name', 'correctAnswer');
                }

                // 提交表单
                this.submit();
            });
        });
    </script>
</body>
</html>
